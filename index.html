<!doctype html>
<html ng-app>
<head>
   <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.0.8/angular.min.js"></script>
   <meta charset="utf-8">
   <meta http-equiv="Content-Type" content="text/html">
   <title>DSL Grading Dashboard</title>
   <link rel="stylesheet" type="text/css" media="all" href="css/styles.css">

   <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
   <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
   <script type="text/javascript" src="http://twitter.github.io/bootstrap/assets/js/bootstrap-dropdown.js"></script>

</head>

<body ng-controller="GitHubCtrl">
   <div id="w">
      <div>
         <h1>DSL Grading Dashboard</h1>
         <h2> (1) Authenticate </h2> <br> 
        <a href="https://github.com/settings/tokens/" target="_blank" id="ghsubmitbtn" >Find Token</a>
        <a href="https://github.com/settings/tokens/new" target="_blank" id="ghsubmitbtn" >Create Token</a>
        <div id="ghapidata" class="clearfix"></div>
      </div>

      <!-- (2) Fill in credentials and get repositories for a given organization -->
      <div>
         <h2> (2) Enter credentials and organization name: </h2> <br>
         <input type="text" id="ghfieldname" ng-model="ghusername" placeholder="GitHub Username">  
         <input type="text" id="ghfieldname" ng-model="ghtoken" placeholder="Personal Access Token">  
         <input type="text" id="ghfieldname" ng-model="orgname" placeholder="Organization Name...">   
        <br>

        <a href="#" id="ghsubmitbtn" ng-click="getReposForOrg()">Load Repositories</a>
        <div id="ghapidata" class="clearfix"></div>
      </div>

      <!-- (2) If no repositories are found  -->
      <div ng-show="orgNotFound">
         <h2>GitHub Organization not found</h2>
      </div>

      <!-- (2) If repositories are found, list out the pull requests -->
      <div ng-show="loaded">
         <div class="ghcontent">
            <p ng-hide="reposFound"></p>
            <div ng-show="reposFound">
               <h3> Repo List </h3>
               <ul ng-repeat="repo in repos" for="{{repo}}">
                  <label name= "repoLabel" > {{repo.name}} 
                      <input 
                        type="radio" 
                        name="selectedRepo"
                        ng-model="$parent.selectedRepo"
                        ng-value="{{repo.name}}"
                     required/> 
                  </label>
               </ul>

               <!-- (3) Get pull requests for a given organization + repository -->
               <a href="#" id="ghsubmitbtn" ng-click="getPullRequestsForRepo()">Load Pull Requests</a>
               <div class="clearfix"></div>
            </div>
      </div>

      <!-- (3) If no repositories are found  -->
      <div ng-show="prNotFound">
         <h2> Pull requests for given repository not found</h2>
      </div>

      <!-- (3) If repositories are found, list out the pull requests -->
      <div ng-show="loaded">
         <div class="ghcontent">
            <p ng-hide="pullsFound"></p>
            <div ng-show="pullsFound">
               <h3> Repo List </h3>
               <ul ng-repeat="pull in pulls" for="{{pull}}">
                  <label name= "pullLabel" > {{pull.title}} 
                      <input 
                        type="radio" 
                        name="selectedPull"
                        ng-model="$parent.selectedPull"
                        ng-value="{{pull.title}}"
                     required/> 
                  </label>
               </ul>

               <!-- (3) Get pull requests for a given organization + repository -->
               <a href="#" id="ghsubmitbtn" ng-click="getPullRequestsForRepo()">Load Pull Requests</a>
               <div class="clearfix"></div>
            </div>
      </div>


   



   <script>
   function GitHubCtrl($scope, $http) {
      $scope.getReposForOrg = function() {
         $scope.orgNotFound = false;
         $scope.loaded = false;

         // Call to find repositories         
         $http.get("https://" +
         $scope.ghusername +
         ":" +
         $scope.ghtoken +
         "@api.github.com/orgs/" +
         $scope.orgname + "/repos")
         .success(function (data) {
            if (data.name == "") data.name = data.name;
            $scope.repos = data;
            $scope.loaded = true;
            $scope.reposFound = data.length > 0;
         })
         .error(function () {
            $scope.orgNotFound = true;
         });

      }
      $scope.getPullRequestsForRepo = function() {

         var radios = document.getElementsByName("selectedRepo");
         var labels = document.getElementsByName("repoLabel");
         var selected = "NOT SET"
         for (var i = 0, length = radios.length; i < length; i++) {
             if (radios[i].checked) {
               selected = labels[i].textContent.replace(/ /g,'');
               break;
             }
         }

         $scope.reponame = selected 
         console.log(selected);

         $scope.prNotFound = false;
         $scope.loaded = false;


         //Call to find repositories
         $http.get("https://" +
         $scope.ghusername +
         ":" +
         $scope.ghtoken +
         "@api.github.com/repos/" +
         $scope.orgname + "/" +
         selected + 
         "/pulls")
         .success(function (data) {
            if (data.name == "") data.name = data.name;
            $scope.pulls = data;
            $scope.loaded = true;
            $scope.pullsFound = data.length > 0;
         })
         .error(function () {
            $scope.prNotFound = true;
         });

      }

      $scope.getFilesForPullRequest = function() {
         // Files in Repo
         $http.get("https://" +
         $scope.ghusername +
         ":" +
         $scope.ghtoken +
         "@api.github.com/repos/" +
         $scope.orgname + "/" +
         selected + 
         "/pulls")
         $http.get("https://api.github.com/repos/" + $scope.username + "/" + $scope.reponame + "/contents").success(function (data) {
            $scope.files = data;
            $scope.reposFound = data.length > 0;
         });
      }
      $scope.getGitInfo = function () {
         $scope.userNotFound = false;
         $scope.loaded = false;
         // User
         $http.get("https://api.github.com/users/" + $scope.username)
         .success(function (data) {
            if (data.name == "") data.name = data.login;
            $scope.user = data;
            $scope.loaded = true;
         })
         .error(function () {
            $scope.userNotFound = true;
         });
         // Repo + Timestamp
         $http.get("https://api.github.com/repos/" + $scope.username + "/" +  $scope.reponame)
         .success(function (data) {
            if (data.name == "") data.name = data.name;
            $scope.reponame = data.name;
            $scope.timestamp = data.pushed_at
            $scope.loaded = true;
         })
         .error(function () {
            $scope.repoNotFound = true;
         });
         // Files in Repo
         $http.get("https://api.github.com/repos/" + $scope.username + "/" + $scope.reponame + "/contents").success(function (data) {
            $scope.files = data;
            $scope.reposFound = data.length > 0;
         });
      }


   }
   </script>

</body>
</html>
